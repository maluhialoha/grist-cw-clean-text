<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grist Text Editor Widget</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Marianne:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --border: #e5e7eb;
      --bg: #ffffff;
      --text: #1f2937;
      --text-light: #6b7280;
      --hover: #f3f4f6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* Mode Configuration */
    .config-mode {
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .config-header {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
      gap: 12px;
    }

    .config-header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .config-header p {
      color: var(--text-light);
      font-size: 14px;
    }

    .config-actions {
      display: flex;
      gap: 12px;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: var(--hover);
      border: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
      border-bottom: none;
    }

    .toolbar-group {
      display: flex;
      gap: 4px;
      padding-right: 8px;
      border-right: 1px solid var(--border);
    }

    .toolbar-group:last-child {
      border-right: none;
    }

    .toolbar-btn {
      padding: 6px 10px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .toolbar-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .toolbar-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    select.toolbar-btn {
      padding: 6px 8px;
      cursor: pointer;
    }

    input[type="color"] {
      width: 40px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
    }

    /* Color Dropdown */
    .color-dropdown-wrapper {
      position: relative;
    }

    .color-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 100;
      min-width: 200px;
      margin-top: 4px;
    }

    .color-dropdown.active {
      display: block;
    }

    .color-presets {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .color-preset {
      width: 40px;
      height: 40px;
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .color-preset:hover {
      transform: scale(1.1);
      border-color: var(--primary);
    }

    .color-custom {
      display: flex;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .color-custom input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }

    .color-custom button {
      padding: 6px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .color-custom button:hover {
      background: var(--primary-hover);
    }

    /* Editor */
    .editor-container {
      border: 1px solid var(--border);
      border-radius: 0 0 8px 8px;
      background: white;
      min-height: 400px;
    }

    #editor {
      padding: 20px;
      min-height: 400px;
      outline: none;
      font-size: 16px;
      line-height: 1.6;
    }

    #editor:empty:before {
      content: attr(data-placeholder);
      color: var(--text-light);
    }

    /* Styles de texte dans l'√©diteur */
    #editor h1 {
      font-size: 2em;
      font-weight: 700;
      margin: 16px 0;
    }

    #editor h2 {
      font-size: 1.5em;
      font-weight: 600;
      margin: 14px 0;
    }

    #editor h3 {
      font-size: 1.25em;
      font-weight: 600;
      margin: 12px 0;
    }

    #editor p {
      margin: 8px 0;
    }

    #editor ul {
      margin: 8px 0;
      padding-left: 40px;
    }

    #editor li {
      margin: 4px 0;
    }

    .display-content ul {
      margin: 8px 0;
      padding-left: 40px;
    }

    .display-content li {
      margin: 4px 0;
    }

    #editor a {
      color: var(--primary);
      text-decoration: underline;
    }

    /* Section repliable */
    .collapsible-section {
      border: 1px solid var(--border);
      border-radius: 6px;
      margin: 12px 0;
      overflow: hidden;
    }

    .collapsible-header {
      background: var(--hover);
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      user-select: none;
    }

    .collapsible-header:hover {
      background: #e5e7eb;
    }

    .collapsible-arrow {
      transition: transform 0.3s;
      font-size: 12px;
    }

    .collapsible-section.collapsed .collapsible-arrow {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      padding: 16px;
      display: block;
    }

    .collapsible-section.collapsed .collapsible-content {
      display: none;
    }

    /* Actions */
    .config-actions {
      margin-top: 20px;
      display: flex;
      gap: 12px;
    }

    .btn-primary {
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-secondary {
      padding: 10px 20px;
      background: white;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background: var(--hover);
    }

    /* Mode Display */
    .display-mode {
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .display-content {
      font-size: 16px;
      line-height: 1.6;
    }

    /* Modal pour les liens */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-content h3 {
      margin-bottom: 16px;
      font-size: 18px;
    }

    .modal-content input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* Emoji Picker Simple */
    .emoji-picker {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 100;
      max-width: 300px;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }

    .emoji-picker.active {
      display: grid;
    }

    .emoji-btn {
      padding: 8px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .emoji-btn:hover {
      background: var(--hover);
    }
  </style>
</head>
<body>
  <!-- Mode Configuration -->
  <div id="configMode" class="config-mode" style="display: none;">
    <div class="config-header">
      <div class="config-actions">
        <button class="btn-secondary" onclick="cancelEdit()">Annuler</button>
        <button class="btn-primary" onclick="saveContent()">Enregistrer</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="execCmd('bold')" title="Gras (Ctrl+B)">
          <strong>B</strong>
        </button>
        <button class="toolbar-btn" onclick="execCmd('italic')" title="Italique (Ctrl+I)">
          <em>I</em>
        </button>
        <button class="toolbar-btn" onclick="execCmd('underline')" title="Soulign√© (Ctrl+U)">
          <u>U</u>
        </button>
        <button class="toolbar-btn" onclick="showLinkModal()" title="Ajouter un lien">
          üîó
        </button>
      </div>

      <div class="toolbar-group">
        <select class="toolbar-btn" onchange="execCmd('formatBlock', this.value); this.selectedIndex=0;">
          <option value="">Style</option>
          <option value="h1">Titre 1</option>
          <option value="h2">Titre 2</option>
          <option value="h3">Titre 3</option>
          <option value="p">Paragraphe</option>
        </select>
      </div>

      <div class="toolbar-group">
        <select class="toolbar-btn" onchange="execCmd('fontName', this.value); this.selectedIndex=0;">
          <option value="">Police</option>
          <option value="Roboto">Roboto</option>
          <option value="Helvetica">Helvetica</option>
          <option value="Verdana">Verdana</option>
          <option value="Arial">Arial</option>
          <option value="'Marianne', sans-serif">Marianne</option>
        </select>
      </div>

      <div class="toolbar-group">
        <div class="color-dropdown-wrapper">
          <button class="toolbar-btn" onclick="toggleColorDropdown()" title="Couleur du texte">
            <span style="color: #000000;" id="currentColorIcon">A</span>
          </button>
          <div id="colorDropdown" class="color-dropdown">
            <div class="color-presets">
              <button class="color-preset" style="background: #000000;" onclick="applyColor('#000000')" title="Noir"></button>
              <button class="color-preset" style="background: #6B7280;" onclick="applyColor('#6B7280')" title="Gris"></button>
              <button class="color-preset" style="background: #EF4444;" onclick="applyColor('#EF4444')" title="Rouge"></button>
              <button class="color-preset" style="background: #F97316;" onclick="applyColor('#F97316')" title="Orange"></button>
              <button class="color-preset" style="background: #F59E0B;" onclick="applyColor('#F59E0B')" title="Jaune"></button>
              <button class="color-preset" style="background: #10B981;" onclick="applyColor('#10B981')" title="Vert"></button>
              <button class="color-preset" style="background: #3B82F6;" onclick="applyColor('#3B82F6')" title="Bleu"></button>
              <button class="color-preset" style="background: #8B5CF6;" onclick="applyColor('#8B5CF6')" title="Violet"></button>
              <button class="color-preset" style="background: #EC4899;" onclick="applyColor('#EC4899')" title="Rose"></button>
            </div>
            <div class="color-custom">
              <input type="text" id="customColorInput" placeholder="#HEX ou nom" />
              <button onclick="applyCustomColor()">OK</button>
            </div>
          </div>
        </div>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="execCmd('insertUnorderedList')" title="Liste √† puces">
          ‚Ä¢ Puce
        </button>
        <button class="toolbar-btn" onclick="insertCollapsible()" title="Section repliable">
          ‚ñº Section
        </button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleEmojiPicker()" title="Ins√©rer un emoji">
          üòÄ Emoji
        </button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showImageModal()" title="Ajouter une image">
          üñºÔ∏è Image
        </button>
      </div>

      <div class="toolbar-group">
        <select class="toolbar-btn" onchange="applyPadding(this.value); this.selectedIndex=0;" title="Marges">
          <option value="">Marges</option>
          <option value="small">Petites</option>
          <option value="medium">Moyennes</option>
          <option value="large">Grandes</option>
        </select>
      </div>
    </div>

    <div class="editor-container">
      <div id="editor" contenteditable="true" data-placeholder="Commencez √† √©crire..."></div>
    </div>

    <!-- Emoji Picker -->
    <div id="emojiPicker" class="emoji-picker"></div>
  </div>

  <!-- Mode Display -->
  <div id="displayMode" class="display-mode">
    <div id="displayContent" class="display-content"></div>
  </div>

  <!-- Modal pour les liens -->
  <div id="linkModal" class="modal">
    <div class="modal-content">
      <h3>Ajouter un lien</h3>
      <input type="text" id="linkText" placeholder="Texte du lien">
      <input type="url" id="linkUrl" placeholder="https://exemple.com">
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeLinkModal()">Annuler</button>
        <button class="btn-primary" onclick="insertLink()">Ins√©rer</button>
      </div>
    </div>
  </div>

  <!-- Modal pour les images -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <h3>Ajouter une image</h3>
      <p style="font-size: 14px; color: var(--text-light); margin-bottom: 12px;">
        URL de l'image ou encodage base64
      </p>
      <input type="text" id="imageUrl" placeholder="https://exemple.com/image.jpg ou data:image/...">
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeImageModal()">Annuler</button>
        <button class="btn-primary" onclick="insertImage()">Ins√©rer</button>
      </div>
    </div>
  </div>

  <script>
    let currentContent = '';
    const configMode = document.getElementById('configMode');
    const displayMode = document.getElementById('displayMode');
    
    // Emojis professionnels
    const emojis = [
      'üìä', 'üìà', 'üìâ', 'üíº', 'üè¢', 'üè≠', 'üèóÔ∏è', '‚öôÔ∏è',
      'üîß', 'üî®', 'üõ†Ô∏è', 'üìã', 'üìå', 'üìç', 'üìé', '‚úÇÔ∏è',
      'üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üìÖ', 'üìÜ', 'üóìÔ∏è', '‚è∞', '‚è±Ô∏è',
      '‚úÖ', '‚ùå', '‚ö†Ô∏è', '‚õî', 'üö´', 'üí°', 'üîî', 'üì¢',
      'üéØ', 'üéì', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', '‚≠ê', '‚ú®',
      'üîç', 'üîé', 'üìù', '‚úèÔ∏è', 'üìß', 'üì®', 'üí¨', 'üí≠'
    ];

    // Initialisation de Grist
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGrist);
    } else {
      initGrist();
    }

    function initGrist() {
      grist.ready({ 
        requiredAccess: 'read table',
        onEditOptions: async () => {
          // Mode configuration
          configMode.style.display = 'block';
          displayMode.style.display = 'none';
          
          // Charger le contenu existant
          const options = await grist.getOptions();
          const savedContent = options?.content || '';
          document.getElementById('editor').innerHTML = savedContent;
          currentContent = savedContent;
          
          initializeEmojiPicker();
        }
      });
      
      grist.onRecords(async (records) => {
        // Mode affichage
        if (configMode.style.display === 'none') {
          const options = await grist.getOptions();
          const content = options?.content || '<p>Cliquez sur "Ouvrir la configuration" pour √©diter le texte.</p>';
          document.getElementById('displayContent').innerHTML = content;
          
          // R√©initialiser les sections repliables
          initCollapsibles();
        }
      });
    }

    // Commandes d'√©dition
    function execCmd(command, value = null) {
      document.getElementById('editor').focus();
      document.execCommand(command, false, value);
    }

    // Gestion des liens
    function showLinkModal() {
      document.getElementById('linkModal').classList.add('active');
      document.getElementById('linkText').value = '';
      document.getElementById('linkUrl').value = '';
      
      // Pr√©-remplir avec la s√©lection si c'est du texte
      const selection = window.getSelection();
      if (selection.toString()) {
        document.getElementById('linkText').value = selection.toString();
      }
      
      document.getElementById('linkText').focus();
    }

    function closeLinkModal() {
      document.getElementById('linkModal').classList.remove('active');
    }

    function insertLink() {
      const text = document.getElementById('linkText').value;
      const url = document.getElementById('linkUrl').value;
      
      if (text && url) {
        const link = `<a href="${url}" target="_blank">${text}</a>`;
        document.execCommand('insertHTML', false, link);
        closeLinkModal();
        document.getElementById('editor').focus();
      }
    }

    // Gestion des images
    function showImageModal() {
      document.getElementById('imageModal').classList.add('active');
      document.getElementById('imageUrl').value = '';
      document.getElementById('imageUrl').focus();
    }

    function closeImageModal() {
      document.getElementById('imageModal').classList.remove('active');
    }

    function insertImage() {
      const url = document.getElementById('imageUrl').value.trim();
      
      if (url) {
        // V√©rifier si une image existe d√©j√†
        const editor = document.getElementById('editor');
        const existingImage = editor.querySelector('img');
        
        if (existingImage) {
          if (confirm('Une image existe d√©j√†. La remplacer ?')) {
            existingImage.src = url;
          }
        } else {
          const img = `<img src="${url}" style="max-width: 100%; height: auto; margin: 16px 0; border-radius: 8px;" />`;
          document.execCommand('insertHTML', false, img);
        }
        
        closeImageModal();
        document.getElementById('editor').focus();
      }
    }

    // Gestion du color dropdown
    function toggleColorDropdown() {
      const dropdown = document.getElementById('colorDropdown');
      dropdown.classList.toggle('active');
    }

    function applyColor(color) {
      document.getElementById('editor').focus();
      document.execCommand('foreColor', false, color);
      document.getElementById('currentColorIcon').style.color = color;
      document.getElementById('colorDropdown').classList.remove('active');
    }

    function applyCustomColor() {
      const input = document.getElementById('customColorInput');
      const color = input.value.trim();
      
      if (color) {
        applyColor(color);
        input.value = '';
      }
    }

    // Fermer le color dropdown si on clique ailleurs
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('colorDropdown');
      const colorBtn = e.target.closest('[onclick*="toggleColorDropdown"]');
      
      if (dropdown && !dropdown.contains(e.target) && !colorBtn) {
        dropdown.classList.remove('active');
      }
    });

    // Gestion des marges
    function applyPadding(size) {
      const editor = document.getElementById('editor');
      const displayContent = document.getElementById('displayContent');
      
      let padding;
      switch(size) {
        case 'small':
          padding = '10px';
          break;
        case 'medium':
          padding = '20px';
          break;
        case 'large':
          padding = '40px';
          break;
        default:
          return;
      }
      
      editor.style.padding = padding;
      displayContent.style.padding = padding;
    }

    // Gestion des emojis
    function initializeEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      picker.innerHTML = '';
      
      emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.onclick = () => insertEmoji(emoji);
        picker.appendChild(btn);
      });
    }

    function toggleEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      picker.classList.toggle('active');
    }

    function insertEmoji(emoji) {
      document.execCommand('insertText', false, emoji);
      document.getElementById('emojiPicker').classList.remove('active');
      document.getElementById('editor').focus();
    }

    // Fermer l'emoji picker si on clique ailleurs
    document.addEventListener('click', function(e) {
      const picker = document.getElementById('emojiPicker');
      const emojiBtn = event.target.closest('[onclick*="toggleEmojiPicker"]');
      
      if (!picker.contains(e.target) && !emojiBtn) {
        picker.classList.remove('active');
      }
    });

    // Section repliable
    function insertCollapsible() {
      const sectionHTML = `
        <div class="collapsible-section" contenteditable="false">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <span contenteditable="true">Titre de la section</span>
            <span class="collapsible-arrow">‚ñº</span>
          </div>
          <div class="collapsible-content" contenteditable="true">
            <p>Contenu de la section...</p>
          </div>
        </div>
        <p><br></p>
      `;
      
      document.execCommand('insertHTML', false, sectionHTML);
    }

    function toggleCollapsible(header) {
      const section = header.parentElement;
      section.classList.toggle('collapsed');
    }

    function initCollapsibles() {
      const headers = document.querySelectorAll('.collapsible-header');
      headers.forEach(header => {
        header.onclick = function() {
          toggleCollapsible(this);
        };
      });
    }

    // Sauvegarde
    async function saveContent() {
      const content = document.getElementById('editor').innerHTML;
      
      await grist.setOptions({
        content: content
      });
      
      // Retour au mode affichage
      document.getElementById('configMode').style.display = 'none';
      document.getElementById('displayMode').style.display = 'block';
      document.getElementById('displayContent').innerHTML = content;
      
      initCollapsibles();
    }

    function cancelEdit() {
      // Restaurer le contenu original
      document.getElementById('editor').innerHTML = currentContent;
      
      // Retour au mode affichage
      document.getElementById('configMode').style.display = 'none';
      document.getElementById('displayMode').style.display = 'block';
    }

    // Raccourcis clavier
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
          case 'b':
            e.preventDefault();
            execCmd('bold');
            break;
          case 'i':
            e.preventDefault();
            execCmd('italic');
            break;
          case 'u':
            e.preventDefault();
            execCmd('underline');
            break;
        }
      }
    });

    // Initialisation au chargement
    window.addEventListener('load', function() {
      initializeEmojiPicker();
    });
  </script>
</body>
</html>