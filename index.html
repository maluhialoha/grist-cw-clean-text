<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grist Text Editor Widget</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Marianne:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --border: #e5e7eb;
      --bg: #ffffff;
      --text: #1f2937;
      --text-light: #6b7280;
      --hover: #f3f4f6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* Mode Configuration */
    .config-mode {
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .config-header {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
      gap: 12px;
    }

    .config-header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .config-header p {
      color: var(--text-light);
      font-size: 14px;
    }

    .config-actions {
      display: flex;
      gap: 12px;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: var(--hover);
      border: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
      border-bottom: none;
    }

    .toolbar-group {
      display: flex;
      gap: 4px;
      padding-right: 8px;
      border-right: 1px solid var(--border);
    }

    .toolbar-group:last-child {
      border-right: none;
    }

    .toolbar-btn {
      padding: 6px 10px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .toolbar-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .toolbar-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    select.toolbar-btn {
      padding: 6px 8px;
      cursor: pointer;
    }

    input[type="color"] {
      width: 40px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
    }

    /* Color Dropdown */
    .color-dropdown-wrapper {
      position: relative;
    }

    .color-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 100;
      min-width: 180px;
      margin-top: 4px;
    }

    .color-dropdown.active {
      display: block;
    }

    .color-presets {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .color-preset {
      width: 22px;
      height: 22px;
      border: 1px solid var(--border);
      border-radius: 3px;
      cursor: pointer;
      transition: transform 0.2s;
      padding: 0;
    }

    .color-preset:hover {
      transform: scale(1.15);
      border-color: var(--primary);
    }

    .color-custom {
      display: flex;
      gap: 4px;
    }

    .color-custom input {
      flex: 1;
      padding: 4px 6px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
    }

    .color-custom button {
      padding: 4px 10px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .color-custom button:hover {
      background: var(--primary-hover);
    }

    /* Editor */
    .editor-container {
      border: 1px solid var(--border);
      border-radius: 0 0 8px 8px;
      background: white;
      min-height: 400px;
    }

    #editor {
      padding: 20px;
      min-height: 400px;
      outline: none;
      font-size: 16px;
      line-height: 1.6;
    }

    #editor:empty:before {
      content: attr(data-placeholder);
      color: var(--text-light);
    }

    /* Styles de texte dans l'√©diteur */
    #editor h1 {
      font-size: 2em;
      font-weight: 700;
      margin: 16px 0;
    }

    #editor h2 {
      font-size: 1.5em;
      font-weight: 600;
      margin: 14px 0;
    }

    #editor h3 {
      font-size: 1.25em;
      font-weight: 600;
      margin: 12px 0;
    }

    #editor p {
      margin: 8px 0;
    }

    #editor ul {
      margin: 8px 0;
      padding-left: 40px;
    }

    #editor li {
      margin: 4px 0;
    }

    .display-content ul {
      margin: 8px 0;
      padding-left: 40px;
    }

    .display-content li {
      margin: 4px 0;
    }

    #editor a {
      color: var(--primary);
      text-decoration: underline;
    }

    /* Styles des tableaux */
    #editor table,
    .display-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 16px 0;
      border: 1px solid var(--border);
    }

    #editor th,
    #editor td,
    .display-content th,
    .display-content td {
      border: 1px solid var(--border);
      padding: 8px 12px;
      text-align: left;
    }

    #editor th,
    .display-content th {
      background: var(--hover);
      font-weight: 600;
    }

    /* Section repliable */
    .collapsible-section {
      border: 1px solid var(--border);
      border-radius: 6px;
      margin: 12px 0;
      overflow: hidden;
    }

    .collapsible-header {
      background: var(--hover);
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      user-select: none;
    }

    .collapsible-header:hover {
      background: #e5e7eb;
    }

    .collapsible-arrow {
      transition: transform 0.3s;
      font-size: 12px;
    }

    .collapsible-section.collapsed .collapsible-arrow {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      padding: 16px;
      display: block;
    }

    .collapsible-section.collapsed .collapsible-content {
      display: none;
    }

    /* Actions */
    .config-actions {
      margin-top: 20px;
      display: flex;
      gap: 12px;
    }

    .btn-primary {
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-secondary {
      padding: 10px 20px;
      background: white;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background: var(--hover);
    }

    /* Mode Display */
    .display-mode {
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .display-content {
      font-size: 16px;
      line-height: 1.6;
    }

    /* Modal pour les liens */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-content h3 {
      margin-bottom: 16px;
      font-size: 18px;
    }

    .modal-content input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* Emoji Picker Simple */
    .emoji-picker {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 100;
      max-width: 300px;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }

    .emoji-picker.active {
      display: grid;
    }

    .emoji-btn {
      padding: 8px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .emoji-btn:hover {
      background: var(--hover);
    }
  </style>
</head>
<body>
  <!-- Mode Configuration -->
  <div id="configMode" class="config-mode" style="display: none;">
    <div class="config-header">
      <div class="config-actions">
        <button class="btn-secondary" onclick="cancelEdit()">Annuler</button>
        <button class="btn-primary" onclick="saveContent()">Enregistrer</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="execCmd('bold')" title="Gras (Ctrl+B)">
          <strong>B</strong>
        </button>
        <button class="toolbar-btn" onclick="execCmd('italic')" title="Italique (Ctrl+I)">
          <em>I</em>
        </button>
        <button class="toolbar-btn" onclick="execCmd('underline')" title="Soulign√© (Ctrl+U)">
          <u>U</u>
        </button>
        <button class="toolbar-btn" onclick="showLinkModal()" title="Ajouter un lien">
          üîó
        </button>
        <button class="toolbar-btn" onclick="execCmd('insertUnorderedList')" title="Liste √† puces">
          ‚Ä¢
        </button>
        <button class="toolbar-btn" onclick="insertCollapsible()" title="Section repliable">
          <span style="font-size: 12px;">‚ñº</span>
        </button>
      </div>

      <div class="toolbar-group">
        <select class="toolbar-btn" onchange="execCmd('formatBlock', this.value); this.selectedIndex=0;">
          <option value="">Style</option>
          <option value="h1">Titre 1</option>
          <option value="h2">Titre 2</option>
          <option value="h3">Titre 3</option>
          <option value="p">Paragraphe</option>
        </select>
      </div>

      <div class="toolbar-group">
        <select class="toolbar-btn" id="fontSelect" onchange="applyFont(this.value)">
          <option value="">Police</option>
          <option value="Roboto">Roboto</option>
          <option value="Helvetica">Helvetica</option>
          <option value="Verdana">Verdana</option>
          <option value="Arial">Arial</option>
          <option value="'Marianne', sans-serif">Marianne</option>
        </select>
      </div>

      <div class="toolbar-group">
        <div class="color-dropdown-wrapper">
          <button class="toolbar-btn" onclick="toggleColorDropdown()" title="Couleur du texte">
            <span style="color: #000000; font-weight: bold; font-size: 16px;" id="currentColorIcon">A</span>
          </button>
          <div id="colorDropdown" class="color-dropdown">
            <div class="color-presets">
              <button class="color-preset" style="background: #000000;" onclick="applyColor('#000000')" title="Noir"></button>
              <button class="color-preset" style="background: #374151;" onclick="applyColor('#374151')" title="Gris fonc√©"></button>
              <button class="color-preset" style="background: #6B7280;" onclick="applyColor('#6B7280')" title="Gris"></button>
              <button class="color-preset" style="background: #9CA3AF;" onclick="applyColor('#9CA3AF')" title="Gris clair"></button>
              <button class="color-preset" style="background: #DC2626;" onclick="applyColor('#DC2626')" title="Rouge"></button>
              <button class="color-preset" style="background: #EF4444;" onclick="applyColor('#EF4444')" title="Rouge clair"></button>
              <button class="color-preset" style="background: #EA580C;" onclick="applyColor('#EA580C')" title="Orange fonc√©"></button>
              <button class="color-preset" style="background: #F97316;" onclick="applyColor('#F97316')" title="Orange"></button>
              <button class="color-preset" style="background: #F59E0B;" onclick="applyColor('#F59E0B')" title="Ambre"></button>
              <button class="color-preset" style="background: #FBBF24;" onclick="applyColor('#FBBF24')" title="Jaune"></button>
              <button class="color-preset" style="background: #84CC16;" onclick="applyColor('#84CC16')" title="Lime"></button>
              <button class="color-preset" style="background: #10B981;" onclick="applyColor('#10B981')" title="Vert"></button>
              <button class="color-preset" style="background: #14B8A6;" onclick="applyColor('#14B8A6')" title="Teal"></button>
              <button class="color-preset" style="background: #06B6D4;" onclick="applyColor('#06B6D4')" title="Cyan"></button>
              <button class="color-preset" style="background: #0EA5E9;" onclick="applyColor('#0EA5E9')" title="Bleu ciel"></button>
              <button class="color-preset" style="background: #3B82F6;" onclick="applyColor('#3B82F6')" title="Bleu"></button>
              <button class="color-preset" style="background: #6366F1;" onclick="applyColor('#6366F1')" title="Indigo"></button>
              <button class="color-preset" style="background: #8B5CF6;" onclick="applyColor('#8B5CF6')" title="Violet"></button>
              <button class="color-preset" style="background: #A855F7;" onclick="applyColor('#A855F7')" title="Mauve"></button>
              <button class="color-preset" style="background: #D946EF;" onclick="applyColor('#D946EF')" title="Fuchsia"></button>
              <button class="color-preset" style="background: #EC4899;" onclick="applyColor('#EC4899')" title="Rose"></button>
            </div>
            <div class="color-custom">
              <input type="text" id="customColorInput" placeholder="#HEX" />
              <button onclick="applyCustomColor()">OK</button>
            </div>
          </div>
        </div>

        <div class="color-dropdown-wrapper">
          <button class="toolbar-btn" onclick="toggleBgColorDropdown()" title="Couleur de fond du texte">
            <span style="background: rgba(255, 255, 0, 0.3); padding: 2px 4px; font-weight: bold; font-size: 16px;" id="currentBgColorIcon">A</span>
          </button>
          <div id="bgColorDropdown" class="color-dropdown">
            <div class="color-presets">
              <button class="color-preset" style="background: rgba(0, 0, 0, 0.1);" onclick="applyBgColor('rgba(0, 0, 0, 0.1)')" title="Gris"></button>
              <button class="color-preset" style="background: rgba(55, 65, 81, 0.15);" onclick="applyBgColor('rgba(55, 65, 81, 0.15)')" title="Gris fonc√©"></button>
              <button class="color-preset" style="background: rgba(107, 114, 128, 0.15);" onclick="applyBgColor('rgba(107, 114, 128, 0.15)')" title="Gris moyen"></button>
              <button class="color-preset" style="background: rgba(156, 163, 175, 0.2);" onclick="applyBgColor('rgba(156, 163, 175, 0.2)')" title="Gris clair"></button>
              <button class="color-preset" style="background: rgba(220, 38, 38, 0.2);" onclick="applyBgColor('rgba(220, 38, 38, 0.2)')" title="Rouge"></button>
              <button class="color-preset" style="background: rgba(239, 68, 68, 0.2);" onclick="applyBgColor('rgba(239, 68, 68, 0.2)')" title="Rouge clair"></button>
              <button class="color-preset" style="background: rgba(234, 88, 12, 0.2);" onclick="applyBgColor('rgba(234, 88, 12, 0.2)')" title="Orange fonc√©"></button>
              <button class="color-preset" style="background: rgba(249, 115, 22, 0.2);" onclick="applyBgColor('rgba(249, 115, 22, 0.2)')" title="Orange"></button>
              <button class="color-preset" style="background: rgba(245, 158, 11, 0.2);" onclick="applyBgColor('rgba(245, 158, 11, 0.2)')" title="Ambre"></button>
              <button class="color-preset" style="background: rgba(251, 191, 36, 0.3);" onclick="applyBgColor('rgba(251, 191, 36, 0.3)')" title="Jaune"></button>
              <button class="color-preset" style="background: rgba(132, 204, 22, 0.2);" onclick="applyBgColor('rgba(132, 204, 22, 0.2)')" title="Lime"></button>
              <button class="color-preset" style="background: rgba(16, 185, 129, 0.2);" onclick="applyBgColor('rgba(16, 185, 129, 0.2)')" title="Vert"></button>
              <button class="color-preset" style="background: rgba(20, 184, 166, 0.2);" onclick="applyBgColor('rgba(20, 184, 166, 0.2)')" title="Teal"></button>
              <button class="color-preset" style="background: rgba(6, 182, 212, 0.2);" onclick="applyBgColor('rgba(6, 182, 212, 0.2)')" title="Cyan"></button>
              <button class="color-preset" style="background: rgba(14, 165, 233, 0.2);" onclick="applyBgColor('rgba(14, 165, 233, 0.2)')" title="Bleu ciel"></button>
              <button class="color-preset" style="background: rgba(59, 130, 246, 0.2);" onclick="applyBgColor('rgba(59, 130, 246, 0.2)')" title="Bleu"></button>
              <button class="color-preset" style="background: rgba(99, 102, 241, 0.2);" onclick="applyBgColor('rgba(99, 102, 241, 0.2)')" title="Indigo"></button>
              <button class="color-preset" style="background: rgba(139, 92, 246, 0.2);" onclick="applyBgColor('rgba(139, 92, 246, 0.2)')" title="Violet"></button>
              <button class="color-preset" style="background: rgba(168, 85, 247, 0.2);" onclick="applyBgColor('rgba(168, 85, 247, 0.2)')" title="Mauve"></button>
              <button class="color-preset" style="background: rgba(217, 70, 239, 0.2);" onclick="applyBgColor('rgba(217, 70, 239, 0.2)')" title="Fuchsia"></button>
              <button class="color-preset" style="background: rgba(236, 72, 153, 0.2);" onclick="applyBgColor('rgba(236, 72, 153, 0.2)')" title="Rose"></button>
            </div>
            <div class="color-custom">
              <input type="text" id="customBgColorInput" placeholder="#HEX" />
              <button onclick="applyCustomBgColor()">OK</button>
            </div>
          </div>
        </div>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="toggleEmojiPicker(event)" title="Ins√©rer un emoji">
          üòÄ
        </button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showTableModal()" title="Ins√©rer un tableau">
          ‚äû
        </button>
      </div>

      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="showImageModal()" title="Ajouter une image">
          üñºÔ∏è
        </button>
      </div>

      <div class="toolbar-group">
        <select class="toolbar-btn" id="paddingSelect" onchange="applyPadding(this.value)">
          <option value="">Marges</option>
          <option value="small">Petites</option>
          <option value="medium">Moyennes</option>
          <option value="large">Grandes</option>
        </select>
      </div>
    </div>

    <div class="editor-container">
      <div id="editor" contenteditable="true" data-placeholder="Commencez √† √©crire..."></div>
    </div>

    <!-- Emoji Picker -->
    <div id="emojiPicker" class="emoji-picker"></div>
  </div>

  <!-- Mode Display -->
  <div id="displayMode" class="display-mode">
    <div id="displayContent" class="display-content"></div>
  </div>

  <!-- Modal pour les liens -->
  <div id="linkModal" class="modal">
    <div class="modal-content">
      <h3>Ajouter un lien</h3>
      <input type="text" id="linkText" placeholder="Texte du lien">
      <input type="url" id="linkUrl" placeholder="https://exemple.com">
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeLinkModal()">Annuler</button>
        <button class="btn-primary" onclick="insertLink()">Ins√©rer</button>
      </div>
    </div>
  </div>

  <!-- Modal pour les images -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <h3>Ajouter une image</h3>
      <p style="font-size: 14px; color: var(--text-light); margin-bottom: 12px;">
        URL de l'image ou encodage base64
      </p>
      <input type="text" id="imageUrl" placeholder="https://exemple.com/image.jpg ou data:image/...">
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeImageModal()">Annuler</button>
        <button class="btn-primary" onclick="insertImage()">Ins√©rer</button>
      </div>
    </div>
  </div>

  <!-- Modal pour les tableaux -->
  <div id="tableModal" class="modal">
    <div class="modal-content">
      <h3>Ins√©rer un tableau</h3>
      <div style="display: flex; gap: 12px; margin-bottom: 12px;">
        <div style="flex: 1;">
          <label style="font-size: 14px; color: var(--text-light); display: block; margin-bottom: 4px;">Lignes</label>
          <input type="number" id="tableRows" min="1" max="20" value="3" style="width: 100%;">
        </div>
        <div style="flex: 1;">
          <label style="font-size: 14px; color: var(--text-light); display: block; margin-bottom: 4px;">Colonnes</label>
          <input type="number" id="tableCols" min="1" max="10" value="3" style="width: 100%;">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeTableModal()">Annuler</button>
        <button class="btn-primary" onclick="insertTable()">Ins√©rer</button>
      </div>
    </div>
  </div>

  <script>
    let currentContent = '';
    const configMode = document.getElementById('configMode');
    const displayMode = document.getElementById('displayMode');
    
    // Emojis professionnels
    const emojis = [
      'üìä', 'üìà', 'üìâ', 'üíº', 'üè¢', 'üè≠', 'üèóÔ∏è', '‚öôÔ∏è',
      'üîß', 'üî®', 'üõ†Ô∏è', 'üìã', 'üìå', 'üìç', 'üìé', '‚úÇÔ∏è',
      'üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üìÖ', 'üìÜ', 'üóìÔ∏è', '‚è∞', '‚è±Ô∏è',
      '‚úÖ', '‚ùå', '‚ö†Ô∏è', '‚õî', 'üö´', 'üí°', 'üîî', 'üì¢',
      'üéØ', 'üéì', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', '‚≠ê', '‚ú®',
      'üîç', 'üîé', 'üìù', '‚úèÔ∏è', 'üìß', 'üì®', 'üí¨', 'üí≠'
    ];

    // Initialisation de Grist
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGrist);
    } else {
      initGrist();
    }

    function initGrist() {
      grist.ready({ 
        requiredAccess: 'read table',
        onEditOptions: async () => {
          // Mode configuration
          configMode.style.display = 'block';
          displayMode.style.display = 'none';
          
          // Charger le contenu existant
          const options = await grist.getOptions();
          const savedContent = options?.content || '';
          const savedFont = options?.font || '';
          const savedPadding = options?.padding || '';
          
          document.getElementById('editor').innerHTML = savedContent;
          currentContent = savedContent;
          
          // Restaurer police et marges
          if (savedFont) {
            currentFont = savedFont;
            applyFont(savedFont);
          }
          
          if (savedPadding) {
            currentPadding = savedPadding;
            applyPadding(savedPadding);
          }
          
          initializeEmojiPicker();
        }
      });
      
      grist.onRecords(async (records) => {
        // Mode affichage
        if (configMode.style.display === 'none') {
          const options = await grist.getOptions();
          const content = options?.content || '<p>Cliquez sur "Ouvrir la configuration" pour √©diter le texte.</p>';
          const savedFont = options?.font || '';
          const savedPadding = options?.padding || '';
          
          document.getElementById('displayContent').innerHTML = content;
          
          // Appliquer police et marges en mode affichage
          if (savedFont) {
            document.getElementById('displayContent').style.fontFamily = savedFont;
          }
          
          if (savedPadding) {
            let padding;
            switch(savedPadding) {
              case 'small': padding = '10px'; break;
              case 'medium': padding = '20px'; break;
              case 'large': padding = '40px'; break;
            }
            if (padding) {
              document.getElementById('displayContent').style.padding = padding;
            }
          }
          
          // R√©initialiser les sections repliables
          initCollapsibles();
        }
      });
    }

    // Commandes d'√©dition
    function execCmd(command, value = null) {
      document.getElementById('editor').focus();
      document.execCommand(command, false, value);
    }

    // Gestion des liens
    let savedSelection = null;
    
    function showLinkModal() {
      // Sauvegarder la s√©lection actuelle
      savedSelection = saveSelection();
      
      document.getElementById('linkModal').classList.add('active');
      document.getElementById('linkText').value = '';
      document.getElementById('linkUrl').value = '';
      
      // Pr√©-remplir avec la s√©lection si c'est du texte
      const selection = window.getSelection();
      if (selection.toString()) {
        document.getElementById('linkText').value = selection.toString();
      }
      
      document.getElementById('linkText').focus();
    }

    function closeLinkModal() {
      document.getElementById('linkModal').classList.remove('active');
      savedSelection = null;
    }

    function saveSelection() {
      if (window.getSelection) {
        const sel = window.getSelection();
        if (sel.getRangeAt && sel.rangeCount) {
          return sel.getRangeAt(0);
        }
      }
      return null;
    }

    function restoreSelection(range) {
      if (range) {
        if (window.getSelection) {
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    }

    function insertLink() {
      const text = document.getElementById('linkText').value.trim();
      let url = document.getElementById('linkUrl').value.trim();
      
      if (text && url) {
        // Ajouter https:// si aucun protocole n'est sp√©cifi√©
        if (!url.match(/^https?:\/\//i)) {
          url = 'https://' + url;
        }
        
        const editor = document.getElementById('editor');
        editor.focus();
        
        // Restaurer la s√©lection si elle existe
        if (savedSelection) {
          restoreSelection(savedSelection);
        }
        
        const link = `<a href="${url}" target="_blank" rel="noopener noreferrer">${text}</a>`;
        document.execCommand('insertHTML', false, link);
        
        closeLinkModal();
      }
    }

    // Gestion des images
    function showImageModal() {
      document.getElementById('imageModal').classList.add('active');
      document.getElementById('imageUrl').value = '';
      document.getElementById('imageUrl').focus();
    }

    function closeImageModal() {
      document.getElementById('imageModal').classList.remove('active');
    }

    function insertImage() {
      let url = document.getElementById('imageUrl').value.trim();
      
      if (url) {
        // Ajouter https:// si aucun protocole n'est sp√©cifi√© et ce n'est pas du base64
        if (!url.match(/^(https?:\/\/|data:)/i)) {
          url = 'https://' + url;
        }
        
        const editor = document.getElementById('editor');
        const existingImage = editor.querySelector('img');
        
        if (existingImage) {
          if (confirm('Une image existe d√©j√†. La remplacer ?')) {
            existingImage.src = url;
            existingImage.style.maxWidth = '100%';
            existingImage.style.height = 'auto';
            existingImage.style.margin = '16px 0';
            existingImage.style.borderRadius = '8px';
            existingImage.style.display = 'block';
          }
        } else {
          editor.focus();
          // Cr√©er un √©l√©ment img directement plut√¥t que via insertHTML
          const imgElement = document.createElement('img');
          imgElement.src = url;
          imgElement.style.maxWidth = '100%';
          imgElement.style.height = 'auto';
          imgElement.style.margin = '16px 0';
          imgElement.style.borderRadius = '8px';
          imgElement.style.display = 'block';
          imgElement.alt = 'Image';
          
          // Ins√©rer l'√©l√©ment
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.insertNode(imgElement);
            range.collapse(false);
          } else {
            editor.appendChild(imgElement);
          }
        }
        
        closeImageModal();
      }
    }

    // Gestion des tableaux
    function showTableModal() {
      document.getElementById('tableModal').classList.add('active');
      document.getElementById('tableRows').value = 3;
      document.getElementById('tableCols').value = 3;
      document.getElementById('tableRows').focus();
    }

    function closeTableModal() {
      document.getElementById('tableModal').classList.remove('active');
    }

    function insertTable() {
      const rows = parseInt(document.getElementById('tableRows').value);
      const cols = parseInt(document.getElementById('tableCols').value);
      
      if (rows > 0 && cols > 0 && rows <= 20 && cols <= 10) {
        let tableHTML = '<table><thead><tr>';
        
        // En-t√™tes
        for (let i = 0; i < cols; i++) {
          tableHTML += '<th>Colonne ' + (i + 1) + '</th>';
        }
        tableHTML += '</tr></thead><tbody>';
        
        // Corps
        for (let i = 0; i < rows; i++) {
          tableHTML += '<tr>';
          for (let j = 0; j < cols; j++) {
            tableHTML += '<td><br></td>';
          }
          tableHTML += '</tr>';
        }
        tableHTML += '</tbody></table><p><br></p>';
        
        document.getElementById('editor').focus();
        document.execCommand('insertHTML', false, tableHTML);
        
        closeTableModal();
      }
    }

    // Gestion du color dropdown
    function toggleColorDropdown() {
      const dropdown = document.getElementById('colorDropdown');
      const bgDropdown = document.getElementById('bgColorDropdown');
      bgDropdown.classList.remove('active');
      dropdown.classList.toggle('active');
    }

    function applyColor(color) {
      document.getElementById('editor').focus();
      document.execCommand('foreColor', false, color);
      document.getElementById('currentColorIcon').style.color = color;
      document.getElementById('colorDropdown').classList.remove('active');
    }

    function applyCustomColor() {
      const input = document.getElementById('customColorInput');
      const color = input.value.trim();
      
      if (color) {
        applyColor(color);
        input.value = '';
      }
    }

    // Gestion du background color dropdown
    function toggleBgColorDropdown() {
      const dropdown = document.getElementById('bgColorDropdown');
      const colorDropdown = document.getElementById('colorDropdown');
      colorDropdown.classList.remove('active');
      dropdown.classList.toggle('active');
    }

    function applyBgColor(color) {
      document.getElementById('editor').focus();
      document.execCommand('backColor', false, color);
      document.getElementById('currentBgColorIcon').style.background = color;
      document.getElementById('bgColorDropdown').classList.remove('active');
    }

    function applyCustomBgColor() {
      const input = document.getElementById('customBgColorInput');
      let color = input.value.trim();
      
      if (color) {
        // Convertir hex en rgba si n√©cessaire
        if (color.match(/^#[0-9A-F]{6}$/i)) {
          const r = parseInt(color.slice(1, 3), 16);
          const g = parseInt(color.slice(3, 5), 16);
          const b = parseInt(color.slice(5, 7), 16);
          color = `rgba(${r}, ${g}, ${b}, 0.2)`;
        }
        applyBgColor(color);
        input.value = '';
      }
    }

    // Fermer les dropdowns si on clique ailleurs
    document.addEventListener('click', function(e) {
      const colorDropdown = document.getElementById('colorDropdown');
      const bgColorDropdown = document.getElementById('bgColorDropdown');
      const colorBtn = e.target.closest('[onclick*="toggleColorDropdown"]');
      const bgColorBtn = e.target.closest('[onclick*="toggleBgColorDropdown"]');
      
      if (colorDropdown && !colorDropdown.contains(e.target) && !colorBtn) {
        colorDropdown.classList.remove('active');
      }
      
      if (bgColorDropdown && !bgColorDropdown.contains(e.target) && !bgColorBtn) {
        bgColorDropdown.classList.remove('active');
      }
    });

    // Gestion de la police (applique √† tout le texte)
    let currentFont = '';
    
    function applyFont(font) {
      if (!font) return;
      
      const editor = document.getElementById('editor');
      const displayContent = document.getElementById('displayContent');
      
      // Appliquer la police directement au conteneur
      editor.style.fontFamily = font;
      displayContent.style.fontFamily = font;
      
      // Pour appliquer aussi au contenu existant, on wrapp tout dans un span
      // mais seulement si c'est lors de l'√©dition
      if (editor.innerHTML && editor.style.display !== 'none') {
        // Nettoyer les anciens spans de police
        const content = editor.innerHTML;
        editor.innerHTML = content;
      }
      
      currentFont = font;
      
      // Mettre √† jour le select
      const fontSelect = document.getElementById('fontSelect');
      if (fontSelect) {
        fontSelect.value = font;
      }
    }

    // Gestion des marges
    let currentPadding = '';
    
    function applyPadding(size) {
      if (!size) return;
      
      const editor = document.getElementById('editor');
      const displayContent = document.getElementById('displayContent');
      
      let padding;
      switch(size) {
        case 'small':
          padding = '10px';
          break;
        case 'medium':
          padding = '20px';
          break;
        case 'large':
          padding = '40px';
          break;
        default:
          return;
      }
      
      editor.style.padding = padding;
      displayContent.style.padding = padding;
      
      currentPadding = size;
      document.getElementById('paddingSelect').value = size;
    }

    // Gestion des emojis
    function initializeEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      picker.innerHTML = '';
      
      emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.onclick = () => insertEmoji(emoji);
        picker.appendChild(btn);
      });
    }

    function toggleEmojiPicker(event) {
      const picker = document.getElementById('emojiPicker');
      
      if (picker.classList.contains('active')) {
        picker.classList.remove('active');
      } else {
        const btn = event.target.closest('.toolbar-btn');
        const rect = btn.getBoundingClientRect();
        
        picker.style.top = (rect.bottom + 4) + 'px';
        picker.style.left = rect.left + 'px';
        
        picker.classList.add('active');
      }
    }

    function insertEmoji(emoji) {
      document.execCommand('insertText', false, emoji);
      document.getElementById('emojiPicker').classList.remove('active');
      document.getElementById('editor').focus();
    }

    // Fermer l'emoji picker si on clique ailleurs
    document.addEventListener('click', function(e) {
      const picker = document.getElementById('emojiPicker');
      const emojiBtn = event.target.closest('[onclick*="toggleEmojiPicker"]');
      
      if (!picker.contains(e.target) && !emojiBtn) {
        picker.classList.remove('active');
      }
    });

    // Section repliable
    function insertCollapsible() {
      const sectionHTML = `
        <div class="collapsible-section" contenteditable="false">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <span contenteditable="true">Titre de la section</span>
            <span class="collapsible-arrow">‚ñº</span>
          </div>
          <div class="collapsible-content" contenteditable="true">
            <p>Contenu de la section...</p>
          </div>
        </div>
        <p><br></p>
      `;
      
      document.execCommand('insertHTML', false, sectionHTML);
    }

    function toggleCollapsible(header) {
      const section = header.parentElement;
      section.classList.toggle('collapsed');
    }

    function initCollapsibles() {
      const headers = document.querySelectorAll('.collapsible-header');
      headers.forEach(header => {
        header.onclick = function() {
          toggleCollapsible(this);
        };
      });
    }

    // Sauvegarde
    async function saveContent() {
      const content = document.getElementById('editor').innerHTML;
      
      await grist.setOptions({
        content: content,
        font: currentFont,
        padding: currentPadding
      });
      
      // Retour au mode affichage
      document.getElementById('configMode').style.display = 'none';
      document.getElementById('displayMode').style.display = 'block';
      document.getElementById('displayContent').innerHTML = content;
      
      // Appliquer police et marges en mode affichage
      if (currentFont) {
        document.getElementById('displayContent').style.fontFamily = currentFont;
      }
      
      if (currentPadding) {
        let padding;
        switch(currentPadding) {
          case 'small': padding = '10px'; break;
          case 'medium': padding = '20px'; break;
          case 'large': padding = '40px'; break;
        }
        if (padding) {
          document.getElementById('displayContent').style.padding = padding;
        }
      }
      
      initCollapsibles();
    }

    function cancelEdit() {
      // Restaurer le contenu original
      document.getElementById('editor').innerHTML = currentContent;
      
      // Retour au mode affichage
      document.getElementById('configMode').style.display = 'none';
      document.getElementById('displayMode').style.display = 'block';
    }

    // Raccourcis clavier
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
          case 'b':
            e.preventDefault();
            execCmd('bold');
            break;
          case 'i':
            e.preventDefault();
            execCmd('italic');
            break;
          case 'u':
            e.preventDefault();
            execCmd('underline');
            break;
        }
      }
    });

    // Initialisation au chargement
    window.addEventListener('load', function() {
      initializeEmojiPicker();
    });
  </script>
</body>
</html>